#!/usr/bin/env node
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(require("child_process"),require("rimraf"),require("inquirer"),require("axios")):"function"==typeof define&&define.amd?define(["child_process","rimraf","inquirer","axios"],r):r((e=e||self).child_process,e.rm$1,e.inquirer$2,e.axios)}(this,function(r,n,i,o){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n,i=i&&i.hasOwnProperty("default")?i.default:i,o=o&&o.hasOwnProperty("default")?o.default:o;var t=require("path"),c=function(e){return/^[./]|(^[a-zA-Z]:)/.test(e)},u=function(e){return t.isAbsolute(e)?e:t.normalize(t.join(process.cwd(),e))},a=require("chalk"),s=require("util").format,l=require("log-symbols"),f="ds-cli",p=a.gray("······");var m={log:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t=s.apply(s,e);console.log(l.info,a.white(f),p,t)},fatal:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];e[0]instanceof Error&&(e[0]=e[0].message.trim());var t=s.apply(s,e);console.error(l.error,a.red(f),p,t),process.exit(1)},success:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t=s.apply(s,e);console.log(l.success,a.green(f),p,t)}};function d(o,a,s,c){return new(s||(s=Promise))(function(e,r){function t(e){try{i(c.next(e))}catch(e){r(e)}}function n(e){try{i(c.throw(e))}catch(e){r(e)}}function i(r){r.done?e(r.value):new s(function(e){e(r.value)}).then(t,n)}i((c=c.apply(o,a||[])).next())})}function h(t,n){var i,o,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function r(r){return function(e){return function(r){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(a=2&r[0]?o.return:r[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,r[1])).done)return a;switch(o=0,a&&(r=[2&r[0],a.value]),r[0]){case 0:case 1:a=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,o=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!a||r[1]>a[0]&&r[1]<a[3])){s.label=r[1];break}if(6===r[0]&&s.label<a[1]){s.label=a[1],a=r;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(r);break}a[2]&&s.ops.pop(),s.trys.pop();continue}r=n.call(t,s)}catch(e){r=[6,e],o=0}finally{i=a=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,e])}}}var g=new(function(){function e(){}return e.prototype.remove=function(e){return new Promise(function(r,t){n(e,function(e){e?t({type:"remove",msg:e}):r()})})},e.prototype.shell=function(e){return new Promise(function(n,i){r.exec(e,function(e,r,t){e?i({type:"shell",msg:r+t}):n(r)})})},e.prototype.ask=function(t){return new Promise(function(r,e){i.prompt(t).then(function(e){r(e)})})},e.prototype.request=function(e){return new Promise(function(r,t){o(e).then(function(e){r(e)}).catch(function(e){t({type:"ajax请求",msg:e})})})},e}()),v=require("semver"),y=require("../package.json"),q=require("chalk"),b=require("log-symbols"),w=require("child_process").execSync,j=function(){var e="",r="";try{e=w("git config --get user.name"),r=w("git config --get user.email")}catch(e){console.log(e)}return((e=e&&JSON.stringify(e.toString().trim()).slice(1,-1))||"")+((r=r&&" <"+r.toString().trim()+">")||"")},k=require("path"),x=require("read-metadata"),S=require("fs").existsSync,O=require("validate-npm-package-name");function P(e,r){var t,n,i=function(e){var r=k.join(e,"meta.json"),t=k.join(e,"meta.js"),n={};if(S(r))n=x.sync(r);else if(S(t)){var i=require(k.resolve(t));if(i!==Object(i))throw new Error("meta.js 需要导出一个对象");n=i}return n}(r);E(i,"name",e),t=i.prompts.name,n=t.validate,t.validate=function(e){var r=O(e);if(r.validForNewPackages)return"function"!=typeof n||n(e);var t=(r.errors||[]).concat(r.warnings||[]);return"Sorry, "+t.join(" and ")+"."};var o=j();return o&&E(i,"author",o),i}function E(e,r,t){e.schema&&(e.prompts=e.schema,delete e.schema);var n=e.prompts||(e.prompts={});n[r]&&"object"==typeof n[r]?n[r].default=t:n[r]={type:"string",default:t}}var _=require("async"),A=require("inquirer"),H={string:"input",boolean:"confirm"};function N(t,n,e){_.eachSeries(Object.keys(t),function(e,r){!function(r,t,e,n){var i=e.default;"function"==typeof e.default&&(i=function(){return e.default.bind(this)(r)});A.prompt([{type:H[e.type]||e.type,name:t,message:e.message||e.label||t,default:i,choices:e.choices||[],validate:e.validate||function(){return!0}}]).then(function(e){Array.isArray(e[t])?(r[t]={},e[t].forEach(function(e){r[t][e]=!0})):"string"==typeof e[t]?r[t]=e[t].replace(/"/g,'\\"'):r[t]=e[t],n()}).catch(n)}(n,e,t[e],r)},e)}var z=require("chalk"),F=require("log-symbols");var G=require("minimatch"),T=function(t,n,i,e){if(!n)return e();var o=Object.keys(t);Object.keys(n).forEach(function(r){o.forEach(function(e){G(e,r,{dot:!0})&&(function(r,e){var t=new Function("data","with (data) { return "+r+"}");try{return t(e)}catch(e){console.error(F.error,z.red("执行meta的filter字段时候的错误"+r))}}(n[r],i)||delete t[e])})}),e()},$=require("chalk"),B=require("metalsmith"),D=require("handlebars"),J=require("async"),M=require("consolidate").handlebars.render,U=require("path");function Z(s,c,u,l){return d(this,void 0,void 0,function(){var o,r,a,t;return h(this,function(e){var n,i;return o=P(s,c),r=B(U.join(c,"template")),a=Object.assign(r.metadata(),{destDirName:s,inPlace:u===process.cwd()}),o.helpers&&Object.keys(o.helpers).map(function(e){D.registerHelper(e,o.helpers[e])}),t={chalk:$,logger:m},o.metalsmith&&"function"==typeof o.metalsmith.before&&o.metalsmith.before(r,o,t),r.use((i=o.prompts,function(e,r,t){N(i,r.metadata(),t)})).use((n=o.filters,function(e,r,t){T(e,n,r.metadata(),t)})).use(function(i,e,r){var t=Object.keys(i),o=e.metadata();J.each(t,function(t,n){var e=i[t].contents.toString();if(!/{{([^{}]+)}}/g.test(e))return n();M(e,o,function(e,r){if(e)return e.message="["+t+"] "+e.message,n(e);i[t].contents=new Buffer(r),n()})},r)}),"function"==typeof o.metalsmith?o.metalsmith(r,o,t):o.metalsmith&&"function"==typeof o.metalsmith.after&&o.metalsmith.after(r,o,t),r.clean(!1).source(".").destination(u).build(function(e,r){if(l(e),"function"==typeof o.complete){var t={chalk:$,logger:m,files:r};o.complete(a,t)}else!function(e,r){if(!e)return;M(e,r,function(e,r){e?console.error("\n模板渲染完成的时候出错 "+e.message.trim()):console.log("\n"+r.split(/\r?\n/g).map(function(e){return"   "+e}).join("\n"))})}(o.completeMessage,a)}),[2,a]})})}D.registerHelper("if_eq",function(e,r,t){return e===r?t.fn(this):t.inverse(this)}),D.registerHelper("unless_eq",function(e,r,t){return e===r?t.inverse(this):t.fn(this)});var C=require("download-git-repo"),I=require("fs").existsSync,K=require("ora"),L=require("rimraf").sync,Q=require("path"),R=require("user-home");require("log-symbols");require("commander");var V=require("fs").existsSync,W=require("inquirer"),X=require("path");var Y=require("log-symbols"),ee=require("chalk");var e=require("commander"),re=require("../package.json"),te={init:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t=e[0],n=e[1],o=X.resolve(n||"."),i=!n||"."===n,a=i?X.relative("../",process.cwd()):n;function s(){if(c(t)){var e=u(t);X.exists(e)?Z(a,e,o,function(e){e&&m.fatal(e),m.success("生成"+a+"文件夹")}):m.fatal("本地模板"+t+"没有找到")}else i=function(){!function(e,r,t,n){var i=K("正在努力下载模板ing...");i.start();var o=Q.join(R,".ds-templates",r.replace(/[\/:]/g,"-"));I(o)&&L(o),C(e,o,{clone:!0},function(e){i.stop(),e&&m.fatal("拉取远程仓库失败 "+r+": "+e.message.trim()),Z(n,o,t,function(e){e&&m.fatal(e),m.success("生成"+n+"文件夹")})})}("direct:https://git.datatub.com/Uranus/ds-cli-"+t+"-template#master",t,o,a)},d(void 0,void 0,void 0,function(){var r,t,n;return h(this,function(e){switch(e.label){case 0:return v.satisfies(process.version,y.engines.node)?[4,g.request({url:"https://registry.npmjs.org/@datastory/ds-cli",method:"GET"})]:[2,console.log(b.error,q.red(" 你的node版本必须 >="+y.engines.node+".x 才能使用ds-cli"))];case 1:return 200===(r=e.sent()).status&&(t=r.data["dist-tags"].latest,n=y.version,v.lt(n,t)&&(console.log(b.info,q.yellow("报告!有一个新的ds-cli版本")),console.log(b.success,"现在最新的是:"+q.green(t)),console.log(b.warning,"你下载的是:"+q.red(n)))),i(),[2]}})});var i}i||V(o)?W.prompt([{type:"confirm",message:i?"在当前目录生成模板":"目录已存在，是否继续？",name:"ok"}]).then(function(e){e.ok&&s()}).catch(m.fatal):s()},list:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];console.log(Y.info,ee.green("正在努力写"))}};function ne(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];re.debug=r[0].debug,te[e].apply(te,r)}e.usage("<command>").version(re.version).description("欢迎使用ds-cli"),e.command("init").description("初始化组件模板").action(function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return ne.apply(void 0,["init"].concat(e))}),e.command("list").description("查看线上组件模板").action(function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return ne.apply(void 0,["list"].concat(e))}),e.command("help").description("查看帮助").action(function(){return e.help()}),e.parse(process.argv),e.args.length||e.help()});
